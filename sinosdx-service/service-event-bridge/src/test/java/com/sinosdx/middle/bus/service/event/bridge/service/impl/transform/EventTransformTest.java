package com.sinosdx.middle.bus.service.event.bridge.service.impl.transform;

import lombok.extern.slf4j.Slf4j;

/**
 * @author pengjiahu
 * @date 2021-07-03 03:32
 * @description
 */
@Slf4j
public class EventTransformTest {

//    public static void main(String[] args) {
//        test2();
//    }
//
//    private static void test1() {
//        String data = "{\"type\":\"error\",\"trace\":null,\"serviceId\":\"(service-event-bridge)\",\"servicePort\":null,\"serverIp\":null,\"serverHost\":null,\"env\":null,\"remoteIp\":null,\"address\":null,\"userAgent\":null,\"requestUri\":\"/events\",\"requestPath\":null,\"description\":null,\"httpMethod\":null,\"requestHeaders\":null,\"responseHeaders\":null,\"methodClass\":\"org.springframework.jdbc.support.SQLStateSQLExceptionTranslator\",\"methodName\":\"doTranslate\",\"params\":null,\"userName\":null,\"actionThread\":null,\"eventTime\":1625253409202,\"userId\":null,\"appCode\":\"(service-event-bridge)\",\"authorization\":null,\"stackTrace\":\"org.springframework.dao.DataIntegrityViolationException: \\n### Error updating database.  Cause: com.mysql.cj.jdbc.exceptions.MysqlDataTruncation: Data truncation: Data too long for column 'spec_version' at row 1\\n### The error may exist in com/sinosdx/middle/bus/service/event/bridge/dao/mapper/EventMapper.java (best guess)\\n### The error may involve com.sinosdx.middle.bus.service.event.bridge.dao.mapper.EventMapper.insert-Inline\\n### The error occurred while setting parameters\\n### SQL: INSERT INTO event  ( event_uuid, source,  spec_version, type, bus_id, bus_name, receive_time, create_time,  creation_date, creation_by, last_update_date, last_updated_by )  VALUES  ( ?, ?,  ?, ?, ?, ?, ?, ?,  ?, ?, ?, ? )\\n### Cause: com.mysql.cj.jdbc.exceptions.MysqlDataTruncation: Data truncation: Data too long for column 'spec_version' at row 1\\n; Data truncation: Data too long for column 'spec_version' at row 1; nested exception is com.mysql.cj.jdbc.exceptions.MysqlDataTruncation: Data truncation: Data too long for column 'spec_version' at row 1\\n\\tat org.springframework.jdbc.support.SQLStateSQLExceptionTranslator.doTranslate(SQLStateSQLExceptionTranslator.java:104)\\n\\tat org.springframework.jdbc.support.AbstractFallbackSQLExceptionTranslator.translate(AbstractFallbackSQLExceptionTranslator.java:70)\\n\\tat org.springframework.jdbc.support.AbstractFallbackSQLExceptionTranslator.translate(AbstractFallbackSQLExceptionTranslator.java:79)\\n\\tat org.springframework.jdbc.support.AbstractFallbackSQLExceptionTranslator.translate(AbstractFallbackSQLExceptionTranslator.java:79)\\n\\tat org.mybatis.spring.MyBatisExceptionTranslator.translateExceptionIfPossible(MyBatisExceptionTranslator.java:88)\\n\\tat org.mybatis.spring.SqlSessionTemplate$SqlSessionInterceptor.invoke(SqlSessionTemplate.java:440)\\n\\tat com.sun.proxy.$Proxy164.insert(Unknown Source)\\n\\tat org.mybatis.spring.SqlSessionTemplate.insert(SqlSessionTemplate.java:271)\\n\\tat com.baomidou.mybatisplus.core.override.MybatisMapperMethod.execute(MybatisMapperMethod.java:60)\\n\\tat com.baomidou.mybatisplus.core.override.MybatisMapperProxy.invoke(MybatisMapperProxy.java:96)\\n\\tat com.sun.proxy.$Proxy195.insert(Unknown Source)\\n\\tat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\\n\\tat sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)\\n\\tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\\n\\tat java\",\"exceptionName\":\"DataIntegrityViolationException\",\"message\":\"\\n### Error updating database.  Cause: com.mysql.cj.jdbc.exceptions.MysqlDataTruncation: Data truncation: Data too long for column 'spec_version' at row 1\\n### The error may exist in com/sinosdx/middle/bus/service/event/bridge/dao/mapper/EventMapper.java (best guess)\\n### The error may involve com.sinosdx.middle.bus.service.event.bridge.dao.mapper.EventMapper.insert-Inline\\n### The error occurred while setting parameters\\n### SQL: INSERT INTO event  ( event_uuid, source,  spec_version, type, bus_id, bus_name, receive_time, create_time,  creation_date, creation_by, last_update_date, last_updated_by )  VALUES  ( ?, ?,  ?, ?, ?, ?, ?, ?,  ?, ?, ?, ? )\\n### Cause: com.mysql.cj.jdbc.exceptions.MysqlDataTruncation: Data truncation: Data too long for column 'spec_version' at row 1\\n; Data truncation: Data too long for column 'spec_version' at row 1; nested exception is com.mysql.cj.jdbc.exceptions.MysqlDataTruncation: Data truncation: Data too long for column 'spec_version' at row 1\",\"fileName\":\"SQLStateSQLExceptionTranslator.java\",\"lineNumber\":104}";
//        String constantExpression = "{appName}->$.serviceId||{message}->$.message||{exceptionName}->$.exceptionName";
//        String template = "服务[{appName}]发生错误，异常类型[{exceptionName}],异常内容[{message}],请服务对应人检查！";
//        String[] strArr = StringUtils.split(constantExpression, "||");
//        if (ArrayUtil.isNotEmpty(strArr)) {
//            for (String str : strArr) {
//                String[] item = StringUtils.split(str, "-->");
//                Object eval = JSONPath.read(String.valueOf(data), item[1]);
//                template = StrUtil.replaceIgnoreCase(template, item[0], String.valueOf(eval));
//            }
//        }
//        System.out.println(template);
//    }
//
//    private static void test2() {
//        List<RuleMode> ruleModeList = new ArrayList<>();
//        RuleMode ruleMode = new RuleMode();
//        ruleMode.setJsonPathExpression(
//                "$..[?(@.exceptionName nin ['MethodArgumentNotValidException','BusinessException','bindException','ConstraintViolationException','BaseException','AuthException','MalformedJwtException','ExpiredJwtException','MethodArgumentTypeMismatchException','RetryableException'])]");
//        ruleMode.setRuleId(1);
//        ruleModeList.add(ruleMode);
//        String data = "{\"type\":\"error\",\"trace\":null,\"serviceId\":\"(service-event-bridge)\",\"servicePort\":null,\"serverIp\":null,\"serverHost\":null,\"env\":null,\"remoteIp\":null,\"address\":null,\"userAgent\":null,\"requestUri\":\"/events\",\"requestPath\":null,\"description\":null,\"httpMethod\":null,\"requestHeaders\":null,\"responseHeaders\":null,\"methodClass\":\"org.springframework.jdbc.support.SQLStateSQLExceptionTranslator\",\"methodName\":\"doTranslate\",\"params\":null,\"userName\":null,\"actionThread\":null,\"eventTime\":1625328475799,\"userId\":null,\"appCode\":\"(service-event-bridge)\",\"authorization\":null,\"stackTrace\":\"org.springframework.dao.DataIntegrityViolationException: \\n### Error updating database.  Cause: com.mysql.cj.jdbc.exceptions.MysqlDataTruncation: Data truncation: Data too long for column 'spec_version' at row 1\\n### The error may exist in com/sinosdx/middle/bus/service/event/bridge/dao/mapper/EventMapper.java (best guess)\\n### The error may involve com.sinosdx.middle.bus.service.event.bridge.dao.mapper.EventMapper.insert-Inline\\n### The error occurred while setting parameters\\n### SQL: INSERT INTO event  ( event_uuid, source,  spec_version, type, bus_id, bus_name, receive_time, create_time,  creation_date, creation_by, last_update_date, last_updated_by )  VALUES  ( ?, ?,  ?, ?, ?, ?, ?, ?,  ?, ?, ?, ? )\\n### Cause: com.mysql.cj.jdbc.exceptions.MysqlDataTruncation: Data truncation: Data too long for column 'spec_version' at row 1\\n; Data truncation: Data too long for column 'spec_version' at row 1; nested exception is com.mysql.cj.jdbc.exceptions.MysqlDataTruncation: Data truncation: Data too long for column 'spec_version' at row 1\\n\\tat org.springframework.jdbc.support.SQLStateSQLExceptionTranslator.doTranslate(SQLStateSQLExceptionTranslator.java:104)\\n\\tat org.springframework.jdbc.support.AbstractFallbackSQLExceptionTranslator.translate(AbstractFallbackSQLExceptionTranslator.java:70)\\n\\tat org.springframework.jdbc.support.AbstractFallbackSQLExceptionTranslator.translate(AbstractFallbackSQLExceptionTranslator.java:79)\\n\\tat org.springframework.jdbc.support.AbstractFallbackSQLExceptionTranslator.translate(AbstractFallbackSQLExceptionTranslator.java:79)\\n\\tat org.mybatis.spring.MyBatisExceptionTranslator.translateExceptionIfPossible(MyBatisExceptionTranslator.java:88)\\n\\tat org.mybatis.spring.SqlSessionTemplate$SqlSessionInterceptor.invoke(SqlSessionTemplate.java:440)\\n\\tat com.sun.proxy.$Proxy164.insert(Unknown Source)\\n\\tat org.mybatis.spring.SqlSessionTemplate.insert(SqlSessionTemplate.java:271)\\n\\tat com.baomidou.mybatisplus.core.override.MybatisMapperMethod.execute(MybatisMapperMethod.java:60)\\n\\tat com.baomidou.mybatisplus.core.override.MybatisMapperProxy.invoke(MybatisMapperProxy.java:96)\\n\\tat com.sun.proxy.$Proxy195.insert(Unknown Source)\\n\\tat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\\n\\tat sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)\\n\\tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\\n\\tat java\",\"exceptionName\":\"DataIntegrityViolationException\",\"message\":\"\\n### Error updating database.  Cause: com.mysql.cj.jdbc.exceptions.MysqlDataTruncation: Data truncation: Data too long for column 'spec_version' at row 1\\n### The error may exist in com/sinosdx/middle/bus/service/event/bridge/dao/mapper/EventMapper.java (best guess)\\n### The error may involve com.sinosdx.middle.bus.service.event.bridge.dao.mapper.EventMapper.insert-Inline\\n### The error occurred while setting parameters\\n### SQL: INSERT INTO event  ( event_uuid, source,  spec_version, type, bus_id, bus_name, receive_time, create_time,  creation_date, creation_by, last_update_date, last_updated_by )  VALUES  ( ?, ?,  ?, ?, ?, ?, ?, ?,  ?, ?, ?, ? )\\n### Cause: com.mysql.cj.jdbc.exceptions.MysqlDataTruncation: Data truncation: Data too long for column 'spec_version' at row 1\\n; Data truncation: Data too long for column 'spec_version' at row 1; nested exception is com.mysql.cj.jdbc.exceptions.MysqlDataTruncation: Data truncation: Data too long for column 'spec_version' at row 1\",\"fileName\":\"SQLStateSQLExceptionTranslator.java\",\"lineNumber\":104,\"id\":7}";
//        List<Integer> list = new EventFilterServiceImpl().matchCustomParam(ruleModeList, data);
//        System.out.println(JSON.toJSONString(list));
//    }

}
